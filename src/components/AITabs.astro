---
import type { Language } from '../i18n/ui';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;

// Translation keys
import { ui } from '../i18n/ui';
const t = ui[lang];

// Color variant mapping (required for Tailwind v4 static analysis)
const colorVariants = {
  tab0: {
    activeButton: 'bg-primary/10 text-primary border-primary/20',
    progress: 'bg-gradient-to-r from-primary/50 to-primary',
    featureDot: 'from-secondary to-accent1',
    valueText: 'text-primary',
    heroBg: 'from-blue-50 to-cyan-50',
    heroBorder: 'border-blue-200/30',
    card0: 'from-cyan-50 to-white border-cyan-200/30',
    card1: 'from-blue-50 to-white border-blue-200/30',
    card2: 'from-indigo-50 to-white border-indigo-200/30',
  },
  tab1: {
    activeButton: 'bg-secondary/10 text-secondary border-secondary/20',
    progress: 'bg-gradient-to-r from-secondary/50 to-secondary',
    featureDot: 'from-primary to-accent2',
    valueText: 'text-secondary',
    pipelineBg: 'from-purple-50 to-blue-50',
    barGradient: 'from-secondary via-primary to-accent1',
    footerBg: 'bg-secondary/5',
  },
  tab2: {
    activeButton: 'bg-accent1/10 text-accent1 border-accent1/20',
    progress: 'bg-gradient-to-r from-accent1/50 to-accent1',
    featureDot: 'from-accent1 to-primary',
    valueText: 'text-accent1',
    hubBg: 'from-cyan-100 to-blue-100',
    hubBorder: 'border-accent1',
    card0: 'from-cyan-50 to-white border-cyan-200/30',
    card1: 'from-blue-50 to-white border-blue-200/30',
    card2: 'from-sky-50 to-white border-sky-200/30',
    card3: 'from-indigo-50 to-white border-indigo-200/30',
  },
  tab3: {
    activeButton: 'bg-accent2/10 text-accent2 border-accent2/20',
    progress: 'bg-gradient-to-r from-accent2/50 to-accent2',
    featureDot: 'from-accent2 to-secondary',
    valueText: 'text-accent2',
    scoreboardBg: 'from-indigo-50 to-blue-50',
    scoreboardBorder: 'border-accent2',
    progressBar: 'from-accent2 to-primary',
    card0: 'from-purple-50 to-white border-purple-200/30',
    card1: 'from-indigo-50 to-white border-indigo-200/30',
  },
} as const;

const inactiveButton = 'text-muted hover:text-text hover:bg-gray-50 border-transparent';

// Tab data structure with 4 unique layout types
const tabs = [
  {
    id: 0,
    label: t['suite.tab1.label'],
    description: t['suite.tab1.description'],
    features: [
      t['suite.tab1.feature1'],
      t['suite.tab1.feature2'],
      t['suite.tab1.feature3'],
      t['suite.tab1.feature4'],
    ],
    color: 'primary',
    testimonial: {
      quote: t['suite.tab1.testimonial.quote'],
      author: t['suite.tab1.testimonial.author'],
    },
    dashboard: {
      type: 'hero' as const, // Hero + Grid layout
      hero: {
        title: t['suite.tab1.hero.title'],
        value: t['suite.tab1.hero.value'],
        status: t['suite.tab1.hero.status'],
      },
      cards: [
        { title: t['suite.tab1.card1.title'], value: t['suite.tab1.card1.value'], status: t['suite.tab1.card1.status'] },
        { title: t['suite.tab1.card2.title'], value: t['suite.tab1.card2.value'], status: t['suite.tab1.card2.status'] },
        { title: t['suite.tab1.card3.title'], value: t['suite.tab1.card3.value'], status: t['suite.tab1.card3.status'] },
      ],
    },
  },
  {
    id: 1,
    label: t['suite.tab2.label'],
    description: t['suite.tab2.description'],
    features: [
      t['suite.tab2.feature1'],
      t['suite.tab2.feature2'],
      t['suite.tab2.feature3'],
      t['suite.tab2.feature4'],
    ],
    color: 'secondary',
    testimonial: {
      quote: t['suite.tab2.testimonial.quote'],
      author: t['suite.tab2.testimonial.author'],
    },
    dashboard: {
      type: 'pipeline' as const, // Vertical funnel layout
      stages: [
        { title: t['suite.tab2.stage1.title'], value: t['suite.tab2.stage1.value'], percent: t['suite.tab2.stage1.percent'] },
        { title: t['suite.tab2.stage2.title'], value: t['suite.tab2.stage2.value'], percent: t['suite.tab2.stage2.percent'] },
        { title: t['suite.tab2.stage3.title'], value: t['suite.tab2.stage3.value'], percent: t['suite.tab2.stage3.percent'] },
        { title: t['suite.tab2.stage4.title'], value: t['suite.tab2.stage4.value'], percent: t['suite.tab2.stage4.percent'] },
      ],
      footer: {
        label: t['suite.tab2.footer.label'],
        value: t['suite.tab2.footer.value'],
        status: t['suite.tab2.footer.status'],
      },
    },
  },
  {
    id: 2,
    label: t['suite.tab3.label'],
    description: t['suite.tab3.description'],
    features: [
      t['suite.tab3.feature1'],
      t['suite.tab3.feature2'],
      t['suite.tab3.feature3'],
      t['suite.tab3.feature4'],
    ],
    color: 'accent1',
    testimonial: {
      quote: t['suite.tab3.testimonial.quote'],
      author: t['suite.tab3.testimonial.author'],
    },
    dashboard: {
      type: 'circular' as const, // Hub & spoke layout
      hub: {
        title: t['suite.tab3.hub.title'],
        value: t['suite.tab3.hub.value'],
        status: t['suite.tab3.hub.status'],
      },
      cards: [
        { title: t['suite.tab3.card1.title'], value: t['suite.tab3.card1.value'], percent: t['suite.tab3.card1.percent'] },
        { title: t['suite.tab3.card2.title'], value: t['suite.tab3.card2.value'], percent: t['suite.tab3.card2.percent'] },
        { title: t['suite.tab3.card3.title'], value: t['suite.tab3.card3.value'], percent: t['suite.tab3.card3.percent'] },
        { title: t['suite.tab3.card4.title'], value: t['suite.tab3.card4.value'], percent: t['suite.tab3.card4.percent'] },
      ],
    },
  },
  {
    id: 3,
    label: t['suite.tab4.label'],
    description: t['suite.tab4.description'],
    features: [
      t['suite.tab4.feature1'],
      t['suite.tab4.feature2'],
      t['suite.tab4.feature3'],
      t['suite.tab4.feature4'],
    ],
    color: 'accent2',
    testimonial: {
      quote: t['suite.tab4.testimonial.quote'],
      author: t['suite.tab4.testimonial.author'],
    },
    dashboard: {
      type: 'scoreboard' as const, // Scoreboard layout
      main: {
        title: t['suite.tab4.main.title'],
        value: t['suite.tab4.main.value'],
        target: t['suite.tab4.main.target'],
        status: t['suite.tab4.main.status'],
      },
      cards: [
        { title: t['suite.tab4.card1.title'], value: t['suite.tab4.card1.value'], target: t['suite.tab4.card1.target'], status: t['suite.tab4.card1.status'] },
        { title: t['suite.tab4.card2.title'], value: t['suite.tab4.card2.value'], target: t['suite.tab4.card2.target'], status: t['suite.tab4.card2.status'] },
      ],
    },
  },
];
---

<!-- Alpine.js is REQUIRED here for tab state, auto-rotation, and progress bar -->
<!-- See docs/ALPINEJS-USAGE-GUIDE.md for when to use Alpine vs Tailwind -->
<section class="relative bg-gradient-to-b from-background to-accent3/20 py-12">
  <div class="max-w-5xl mx-auto px-6">

    <!-- Section Title -->
    <div class="mb-6 text-center">
      <h2 class="font-display text-3xl font-bold text-text mb-2">
        <span class="title-icon"></span>{t['suite.title'] || 'AI Suite'}
      </h2>
      <p class="text-base text-muted max-w-3xl mx-auto">
        {t['suite.subtitle'] || 'Powerful AI tools for your business'}
      </p>
    </div>

    <!-- Tab Buttons -->
    <!-- Alpine component registered in client.ts (moved from inline due to Astro 5.16.x multi-line attribute bug) -->
    <div
      x-data="aiTabs"
      x-init="startAutoRotate()"
      @mouseenter="stopAutoRotate()"
      @mouseleave="startAutoRotate()"
      @touchstart="stopAutoRotate()"
      class="relative"
    >

      <!-- Tab Navigation - Enhanced with Glassmorphism -->
      <div class="bg-white/90 backdrop-blur-lg border border-gray-100/80 rounded-2xl p-1.5 mb-6 shadow-[0_1px_3px_rgba(0,0,0,0.05),0_4px_15px_rgba(0,0,0,0.08)]">
        <nav class="flex flex-wrap gap-1">
          {tabs.map((tab, index) => (
            <button
              @click={`selectTab(${index})`}
              :class={`activeTab === ${index} ? '${colorVariants[`tab${index}` as keyof typeof colorVariants].activeButton} shadow-sm' : '${inactiveButton}'`}
              class="relative flex-1 min-w-[120px] py-2.5 px-3 rounded-xl font-heading font-semibold text-xs tracking-wide transition-all duration-500 border"
            >
              {tab.label}

              <!-- Progress bar on active tab with gradient (only visible on active tab) -->
              <div
                x-show={`activeTab === ${index}`}
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-bind:style={`activeTab === ${index} ? 'width: ' + progress + '%' : 'width: 0%'`}
                class={`absolute bottom-0 left-0 h-0.5 rounded-full transition-all duration-100 ${colorVariants[`tab${index}` as keyof typeof colorVariants].progress}`}
              ></div>
            </button>
          ))}
        </nav>
      </div>

      <!-- Paused Indicator -->
      <div
        x-show="isPaused"
        x-transition
        class="absolute top-2 right-2 bg-gray-900/80 text-white text-xs px-3 py-1.5 rounded-full backdrop-blur-sm shadow-lg z-10"
      >
        ⏸ {lang === 'fr' ? 'En pause' : 'Paused'}
      </div>

      <!-- Tab Content - 40/60 Split Layout with Slide Animations -->
      <!-- x-intersect detects when tabs enter/leave viewport for floating button visibility -->
      <div
        x-intersect:enter="isInView = true"
        x-intersect:leave="isInView = false"
        class="bg-white border border-gray-100 rounded-2xl shadow-lg overflow-hidden h-[480px]">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-0 h-full">

          {tabs.map((tab, index) => (
            <div
              x-show={`activeTab === ${index}`}
              x-transition:enter="transition ease-out duration-600"
              x-transition:enter-start="opacity-0"
              x-transition:enter-end="opacity-100"
              class="col-span-full grid grid-cols-1 lg:grid-cols-5 gap-0 h-full"
              style="display: none;"
            >

              <!-- Left Panel: Description & Features (40% = 2/5 cols) -->
              <div
                class="lg:col-span-2 px-6 py-5 flex flex-col h-full overflow-y-auto"
                x-show={`activeTab === ${index}`}
                x-transition:enter="transition ease-out duration-600 delay-100"
                x-transition:enter-start="opacity-0 transform -translate-x-4"
                x-transition:enter-end="opacity-100 transform translate-x-0"
              >
                <!-- Title -->
                <h3 class="text-2xl font-display font-medium text-text mb-3 tracking-tight leading-tight">
                  {tab.label}
                </h3>

                <!-- Description -->
                <p class="text-sm text-muted font-medium leading-relaxed mb-4">
                  {tab.description}
                </p>

                <!-- Features List -->
                <div class="space-y-2">
                  <h4 class="text-xs font-heading font-bold uppercase tracking-wider text-subtle">
                    {lang === 'fr' ? 'Comment ça marche' : 'How it works'}
                  </h4>
                  <ul class="space-y-1.5">
                    {tab.features.map((feature) => (
                      <li class="flex items-start gap-3 group">
                        <span class={`inline-block w-1.5 h-1.5 rounded-full mt-2 flex-shrink-0 transition-transform group-hover:scale-125 bg-gradient-to-br ${colorVariants[`tab${index}` as keyof typeof colorVariants].featureDot}`}></span>
                        <span class="text-sm text-muted font-medium">{feature}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              <!-- Right Panel: Dashboard (60% = 3/5 cols) -->
              <div
                class="lg:col-span-3 bg-gray-50 px-5 py-4 h-full overflow-y-auto"
                x-show={`activeTab === ${index}`}
                x-transition:enter="transition ease-out duration-600 delay-100"
                x-transition:enter-start="opacity-0 transform translate-x-4"
                x-transition:enter-end="opacity-100 transform translate-x-0"
              >

                {/* ============================================
                    TAB 1: HERO + GRID LAYOUT
                    Large hero metric + 3 supporting cards below
                ============================================ */}
                {tab.dashboard.type === 'hero' && 'hero' in tab.dashboard && (
                  <div class="space-y-3">
                    {/* Hero Card - Large prominent metric */}
                    <div class={`rounded-xl p-4 bg-gradient-to-br ${colorVariants.tab0.heroBg} border ${colorVariants.tab0.heroBorder} shadow-sm`}>
                      <p class="text-xs font-medium text-muted mb-1">{tab.dashboard.hero.title}</p>
                      <div class={`text-4xl md:text-5xl font-bold ${colorVariants.tab0.valueText} mb-1`}>
                        {tab.dashboard.hero.value}
                      </div>
                      <p class="text-xs text-muted">{tab.dashboard.hero.status}</p>
                    </div>

                    {/* Supporting Cards - 3 columns */}
                    <div class="grid grid-cols-3 gap-2">
                      {tab.dashboard.cards.map((card, cardIndex) => (
                        <div class={`rounded-lg p-3 bg-gradient-to-br ${colorVariants.tab0[`card${cardIndex}` as 'card0' | 'card1' | 'card2']} border shadow-sm hover:shadow-md transition-all`}>
                          <p class="text-xs font-medium text-subtle mb-0.5">{card.title}</p>
                          <div class={`text-lg md:text-xl font-bold ${colorVariants.tab0.valueText}`}>{card.value}</div>
                          <p class="text-xs text-muted">{card.status}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* ============================================
                    TAB 2: PIPELINE LAYOUT
                    Vertical funnel with progress bars
                ============================================ */}
                {tab.dashboard.type === 'pipeline' && 'stages' in tab.dashboard && (
                  <div class="space-y-1.5">
                    {/* Pipeline Header */}
                    <p class="text-xs font-bold text-subtle uppercase tracking-wider mb-1">
                      {lang === 'fr' ? 'Votre Pipeline Commercial' : 'Your Sales Pipeline'}
                    </p>

                    {/* Pipeline Stages */}
                    {tab.dashboard.stages.map((stage, stageIndex) => (
                      <div class="space-y-0.5">
                        <div class="flex justify-between items-center">
                          <span class="text-xs font-medium text-text">{stage.title}</span>
                          <span class="text-xs font-bold text-text">{stage.value}</span>
                        </div>
                        <div class="relative h-5 bg-gray-200 rounded-full overflow-hidden">
                          <div
                            class={`absolute inset-y-0 left-0 bg-gradient-to-r ${colorVariants.tab1.barGradient} rounded-full transition-all`}
                            style={`width: ${stage.percent}%`}
                          >
                            <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs font-bold text-white">
                              {stage.percent}%
                            </span>
                          </div>
                        </div>
                      </div>
                    ))}

                    {/* Footer Summary */}
                    <div class={`mt-2 pt-2 border-t border-secondary/20 ${colorVariants.tab1.footerBg} rounded-lg p-2 text-center`}>
                      <p class="text-xs text-muted">{tab.dashboard.footer.label}</p>
                      <div class={`text-xl font-bold ${colorVariants.tab1.valueText}`}>
                        {tab.dashboard.footer.value}
                      </div>
                      <p class="text-xs text-muted">{tab.dashboard.footer.status}</p>
                    </div>
                  </div>
                )}

                {/* ============================================
                    TAB 3: CIRCULAR / HUB & SPOKE LAYOUT
                    Central hub metric + 4 mini cards around
                ============================================ */}
                {tab.dashboard.type === 'circular' && 'hub' in tab.dashboard && (
                  <div class="flex flex-col items-center">
                    {/* Central Hub - Circle */}
                    <div class={`relative w-32 h-32 rounded-full bg-gradient-to-br ${colorVariants.tab2.hubBg} border-4 ${colorVariants.tab2.hubBorder} shadow-lg flex items-center justify-center mb-2`}>
                      <div class="text-center">
                        <div class={`text-3xl font-bold ${colorVariants.tab2.valueText}`}>
                          {tab.dashboard.hub.value}
                        </div>
                        <p class="text-xs text-muted px-2">{tab.dashboard.hub.title}</p>
                      </div>
                    </div>

                    {/* Status below hub */}
                    <p class="text-xs text-muted text-center mb-2">{tab.dashboard.hub.status}</p>

                    {/* Mini Cards - 2x2 grid */}
                    <div class="grid grid-cols-2 gap-2 w-full">
                      {tab.dashboard.cards.map((card, cardIndex) => (
                        <div class={`rounded-lg p-2.5 bg-gradient-to-br ${colorVariants.tab2[`card${cardIndex}` as 'card0' | 'card1' | 'card2' | 'card3']} border shadow-sm text-center hover:shadow-md transition-all`}>
                          <p class="text-xs font-medium text-subtle">{card.title}</p>
                          <div class={`text-lg font-bold ${colorVariants.tab2.valueText}`}>{card.value}</div>
                          <span class={`inline-block text-xs font-bold ${colorVariants.tab2.valueText} bg-accent1/10 px-2 py-0.5 rounded-full`}>
                            {card.percent}%
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* ============================================
                    TAB 4: SCOREBOARD LAYOUT
                    Main scoreboard + 2 supporting cards
                ============================================ */}
                {tab.dashboard.type === 'scoreboard' && 'main' in tab.dashboard && (
                  <div class="space-y-3">
                    {/* Main Scoreboard */}
                    <div class={`rounded-xl p-4 bg-gradient-to-br ${colorVariants.tab3.scoreboardBg} border-2 ${colorVariants.tab3.scoreboardBorder} shadow-lg`}>
                      <p class="text-xs font-bold text-accent2 uppercase tracking-wider text-center mb-2">
                        {tab.dashboard.main.title}
                      </p>

                      {/* Main Value */}
                      <div class={`text-4xl md:text-5xl font-bold text-text text-center mb-2`}>
                        {tab.dashboard.main.value}
                      </div>

                      {/* Progress to Target */}
                      <div class="space-y-1">
                        <div class="flex justify-between text-xs text-muted">
                          <span>{lang === 'fr' ? 'Actuel' : 'Current'}</span>
                          <span>{lang === 'fr' ? 'Objectif' : 'Target'}: {tab.dashboard.main.target}</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div
                            class={`h-full bg-gradient-to-r ${colorVariants.tab3.progressBar} rounded-full`}
                            style="width: 94%"
                          ></div>
                        </div>
                      </div>

                      {/* Status */}
                      <p class="text-xs text-muted text-center mt-2">{tab.dashboard.main.status}</p>
                    </div>

                    {/* Supporting Cards - 2 columns */}
                    <div class="grid grid-cols-2 gap-2">
                      {tab.dashboard.cards.map((card, cardIndex) => (
                        <div class={`rounded-lg p-3 bg-gradient-to-br ${colorVariants.tab3[`card${cardIndex}` as 'card0' | 'card1']} border shadow-sm text-center`}>
                          <p class="text-xs font-bold text-accent2 uppercase tracking-wide mb-1">{card.title}</p>
                          <div class={`text-xl md:text-2xl font-bold text-text`}>{card.value}</div>
                          <p class="text-xs text-muted">{lang === 'fr' ? 'Objectif' : 'Target'}: {card.target}</p>
                          <span class={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full ${card.status.startsWith('✓') ? 'text-green-700 bg-green-50' : 'text-accent2 bg-accent2/10'}`}>
                            {card.status}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Testimonial Quote - Embedded in dashboard visual */}
                {tab.testimonial && (
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="relative">
                      <svg class="absolute -top-0.5 -left-0.5 w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                      </svg>
                      <blockquote class="pl-5 text-xs text-muted italic leading-relaxed">
                        "{tab.testimonial.quote}"
                      </blockquote>
                      <p class="mt-1 pl-5 text-xs font-medium text-subtle">
                        — {tab.testimonial.author}
                      </p>
                    </div>
                  </div>
                )}

              </div>
            </div>
          ))}

        </div>

      </div>

      <!-- Floating Mobile Navigation Buttons -->
      <!-- Alpine.js is REQUIRED here for prev/next navigation and dynamic colors -->
      <!-- Only visible on mobile (< lg breakpoint) AND when tabs are in viewport -->
      <div
        x-show="isInView"
        x-transition
        class="lg:hidden fixed bottom-6 right-6 flex gap-3 z-20">
        <!-- Tab Indicator -->
        <div
          class="flex items-center justify-center bg-white/90 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg border border-gray-200"
          x-transition
        >
          <span class="text-xs font-semibold text-muted" x-text="`${activeTab + 1}/${totalTabs}`"></span>
        </div>

        <!-- Previous Button -->
        <button
          @click="prevTab()"
          class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg backdrop-blur-sm border border-gray-200 transition-all active:scale-95 hover:scale-105"
          :class="{
            'bg-primary/10 text-primary': activeTab === 0,
            'bg-secondary/10 text-secondary': activeTab === 1,
            'bg-accent1/10 text-accent1': activeTab === 2,
            'bg-accent2/10 text-accent2': activeTab === 3
          }"
          aria-label="Previous tab"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <!-- Next Button -->
        <button
          @click="nextTab()"
          class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg backdrop-blur-sm border border-gray-200 transition-all active:scale-95 hover:scale-105"
          :class="{
            'bg-primary/10 text-primary': activeTab === 0,
            'bg-secondary/10 text-secondary': activeTab === 1,
            'bg-accent1/10 text-accent1': activeTab === 2,
            'bg-accent2/10 text-accent2': activeTab === 3
          }"
          aria-label="Next tab"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

    </div>
  </div>
</section>
