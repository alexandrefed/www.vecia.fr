---
/**
 * BilanForm Component
 *
 * Single-page form for AI assessment lead capture
 * Sends data to vecia-audit-ia API to generate personalized PDF
 */

interface Props {
  lang: 'fr' | 'en';
}

const { lang } = Astro.props;

const t = {
  fr: {
    sections: {
      company: "Vous & votre entreprise",
      companySubtitle: "Quelques infos pour personnaliser votre bilan",
      daily: "Votre quotidien"
    },
    maturity: {
      label: "O√π en √™tes-vous avec l'IA ?",
      options: [
        { value: 1, label: 'D√©butant', desc: "Je n'utilise pas encore l'IA" },
        { value: 2, label: 'Curieux', desc: "J'ai test√© ChatGPT ou similaire" },
        { value: 3, label: 'Pratiquant', desc: "J'utilise l'IA r√©guli√®rement" },
        { value: 4, label: 'Avanc√©', desc: "J'ai d√©ploy√© des solutions IA" }
      ]
    },
    toolsFrequent: {
      label: "Quels outils utilisez-vous tr√®s r√©guli√®rement ?",
      placeholder: "Ex: Outlook, Excel, Teams, Notion..."
    },
    toolsOccasional: {
      label: "Quels outils utilisez-vous occasionnellement ?",
      placeholder: "Ex: Canva, ChatGPT, outils m√©tier sp√©cifiques..."
    },
    aiPriority: {
      label: "Quelles sont vos attentes vis-√†-vis de l'IA ?",
      optional: "(optionnel)",
      cards: [
        { value: 'decisionnel', icon: 'üìä', title: 'Piloter & D√©cider', desc: 'Croiser les donn√©es, anticiper les tendances' },
        { value: 'operationnel', icon: '‚ö°', title: 'Automatiser', desc: 'Gagner du temps sur les t√¢ches r√©p√©titives' },
        { value: 'commercial', icon: 'üíº', title: 'Vendre & Fid√©liser', desc: 'Augmenter les ventes, am√©liorer l\'exp√©rience' }
      ]
    },
    repetitiveProcess: {
      label: "D√©crivez un process r√©p√©titif que vous aimeriez automatiser",
      placeholder: "Ex: relancer les devis non sign√©s, cr√©er des rapports hebdo, trier les emails..."
    },
    objectives: {
      label: "Quel est votre principal d√©fi aujourd'hui ?",
      placeholder: "Ex: g√©rer mes leads, relancer mes clients, automatiser ma compta..."
    },
    company: {
      sizeLabel: "Taille de l'entreprise",
      sizeOptions: [
        { value: '1-10', label: '1-10' },
        { value: '11-50', label: '11-50' },
        { value: '51-200', label: '51-200' },
        { value: '201-1000', label: '201-1000' },
        { value: '1000+', label: '1000+' }
      ],
      sectorLabel: "Secteur d'activit√©",
      sectorOptions: [
        { value: 'Services', label: 'Services aux entreprises' },
        { value: 'Commerce', label: 'Commerce / Retail' },
        { value: 'Industrie', label: 'Industrie / Manufacturing' },
        { value: 'Tech', label: 'Tech / SaaS' },
        { value: 'Finance', label: 'Finance / Assurance' },
        { value: 'Sante', label: 'Sant√© / Pharma' },
        { value: 'Immobilier', label: 'Immobilier / Construction' },
        { value: 'Transport', label: 'Transport / Logistique' },
        { value: 'Education', label: '√âducation / Formation' },
        { value: 'Autre', label: 'Autre' }
      ]
    },
    labels: {
      name: "Votre nom",
      namePlaceholder: "",
      email: "Email professionnel",
      emailPlaceholder: "",
      company: "Nom de l'entreprise",
      companyPlaceholder: "",
      website: "Site web",
      websitePlaceholder: "https://",
      role: "Fonction",
      rolePlaceholder: "Ex: Dirigeant, Commercial, RH...",
      activityDescription: "D√©crivez votre activit√©",
      activityDescriptionPlaceholder: "Que fait votre entreprise ? Quels sont vos clients ?"
    },
    gdpr: {
      label: "J'accepte que mes donn√©es soient utilis√©es pour g√©n√©rer mon bilan personnalis√©",
      link: "Politique de confidentialit√©"
    },
    submit: "Recevoir mon bilan gratuit",
    success: {
      title: "Votre bilan est en cours !",
      message: "Vous recevrez votre bilan personnalis√© par email dans les prochaines minutes.",
      checkSpam: "Pensez √† v√©rifier vos spams."
    },
    error: "Une erreur s'est produite. Veuillez r√©essayer."
  },
  en: {
    sections: {
      company: "You & your company",
      companySubtitle: "A few details to personalize your assessment",
      daily: "Your daily work"
    },
    maturity: {
      label: "Where are you with AI?",
      options: [
        { value: 1, label: 'Beginner', desc: "I don't use AI yet" },
        { value: 2, label: 'Curious', desc: "I've tried ChatGPT or similar" },
        { value: 3, label: 'Practitioner', desc: "I use AI regularly" },
        { value: 4, label: 'Advanced', desc: "I've deployed AI solutions" }
      ]
    },
    toolsFrequent: {
      label: "What tools do you use very frequently?",
      placeholder: "e.g., Outlook, Excel, Teams, Notion..."
    },
    toolsOccasional: {
      label: "What tools do you use occasionally?",
      placeholder: "e.g., Canva, ChatGPT, specialized business tools..."
    },
    aiPriority: {
      label: "What are your AI expectations?",
      optional: "(optional)",
      cards: [
        { value: 'decisionnel', icon: 'üìä', title: 'Analyze & Decide', desc: 'Cross-reference data, anticipate trends' },
        { value: 'operationnel', icon: '‚ö°', title: 'Automate', desc: 'Save time on repetitive tasks' },
        { value: 'commercial', icon: 'üíº', title: 'Sell & Retain', desc: 'Increase sales, improve customer experience' }
      ]
    },
    repetitiveProcess: {
      label: "Describe a repetitive process you'd like to automate",
      placeholder: "e.g., follow up on unsigned quotes, create weekly reports, sort emails..."
    },
    objectives: {
      label: "What is your main challenge today?",
      placeholder: "e.g., manage leads, follow up with clients, automate accounting..."
    },
    company: {
      sizeLabel: "Company size",
      sizeOptions: [
        { value: '1-10', label: '1-10' },
        { value: '11-50', label: '11-50' },
        { value: '51-200', label: '51-200' },
        { value: '201-1000', label: '201-1000' },
        { value: '1000+', label: '1000+' }
      ],
      sectorLabel: "Industry",
      sectorOptions: [
        { value: 'Services', label: 'Business Services' },
        { value: 'Commerce', label: 'Commerce / Retail' },
        { value: 'Industrie', label: 'Manufacturing' },
        { value: 'Tech', label: 'Tech / SaaS' },
        { value: 'Finance', label: 'Finance / Insurance' },
        { value: 'Sante', label: 'Healthcare / Pharma' },
        { value: 'Immobilier', label: 'Real Estate / Construction' },
        { value: 'Transport', label: 'Transport / Logistics' },
        { value: 'Education', label: 'Education / Training' },
        { value: 'Autre', label: 'Other' }
      ]
    },
    labels: {
      name: "Your name",
      namePlaceholder: "",
      email: "Professional email",
      emailPlaceholder: "",
      company: "Company name",
      companyPlaceholder: "",
      website: "Website",
      websitePlaceholder: "https://",
      role: "Role / Function",
      rolePlaceholder: "e.g., CEO, Sales, HR...",
      activityDescription: "Describe your business",
      activityDescriptionPlaceholder: "What does your company do? Who are your customers?"
    },
    gdpr: {
      label: "I agree that my data will be used to generate my personalized assessment",
      link: "Privacy policy"
    },
    submit: "Get my free assessment",
    success: {
      title: "Your assessment is being generated!",
      message: "You will receive your personalized assessment by email in the next few minutes.",
      checkSpam: "Remember to check your spam folder."
    },
    error: "An error occurred. Please try again."
  }
}[lang];
---

<div
  x-data="bilanForm()"
  class="max-w-2xl mx-auto"
>
  <!-- Form Container -->
  <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8" x-show="!success" x-transition>

    <!-- Section 1: Contact + Company Info -->
    <div class="mb-8">
      <h2 class="text-xl md:text-2xl font-heading font-bold text-text mb-1">{t.sections.company}</h2>
      <p class="text-sm text-muted mb-5">{t.sections.companySubtitle}</p>

      <div class="space-y-4">
        <!-- Row 1: Name + Email -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">
              {t.labels.name} <span class="text-secondary">*</span>
            </label>
            <input
              type="text"
              x-model="formData.contact_name"
              required
              placeholder={t.labels.namePlaceholder}
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">
              {t.labels.email} <span class="text-secondary">*</span>
            </label>
            <input
              type="email"
              x-model="formData.email"
              required
              placeholder={t.labels.emailPlaceholder}
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
            />
          </div>
        </div>

        <!-- Row 2: Company + Website -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">
              {t.labels.company} <span class="text-secondary">*</span>
            </label>
            <input
              type="text"
              x-model="formData.company_name"
              required
              placeholder={t.labels.companyPlaceholder}
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">
              {t.labels.website}
            </label>
            <input
              type="url"
              x-model="formData.website"
              placeholder={t.labels.websitePlaceholder}
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
            />
          </div>
        </div>

        <!-- Conditional: Activity Description (if no website) -->
        <div x-show="!formData.website || formData.website.trim() === ''" x-transition>
          <label class="block text-sm font-medium text-text mb-1.5">
            {t.labels.activityDescription} <span class="text-secondary">*</span>
          </label>
          <textarea
            x-model="formData.activity_description"
            rows="2"
            placeholder={t.labels.activityDescriptionPlaceholder}
            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle resize-none text-sm"
          ></textarea>
        </div>

        <!-- Row 3: Role + Sector -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">{t.labels.role}</label>
            <input
              type="text"
              x-model="formData.role"
              placeholder={t.labels.rolePlaceholder}
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1.5">
              {t.company.sectorLabel} <span class="text-secondary">*</span>
            </label>
            <select
              x-model="formData.sector"
              class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text text-sm"
            >
              <option value="">-- {lang === 'fr' ? 'S√©lectionnez' : 'Select'} --</option>
              {t.company.sectorOptions.map((option) => (
                <option value={option.value}>{option.label}</option>
              ))}
            </select>
          </div>
        </div>

        <!-- Row 4: Company Size -->
        <div>
          <label class="block text-sm font-medium text-text mb-2">
            {t.company.sizeLabel} <span class="text-secondary">*</span>
          </label>
          <div class="flex flex-wrap gap-2">
            {t.company.sizeOptions.map((option) => (
              <button
                type="button"
                x-on:click={`formData.company_size = '${option.value}'`}
                x-bind:class={`formData.company_size === '${option.value}' ? 'border-primary bg-primary/10 text-primary' : 'border-gray-200 hover:border-primary/50'`}
                class="px-4 py-2 border-2 rounded-lg transition-all text-sm font-medium"
              >
                {option.label}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Divider -->
    <div class="border-t border-gray-200 my-6"></div>

    <!-- Section 2: AI Maturity + Tools -->
    <div>
      <h2 class="text-xl md:text-2xl font-heading font-bold text-text mb-5">{t.sections.daily}</h2>

      <div class="space-y-5">
        <!-- AI Maturity -->
        <div>
          <label class="block text-sm font-medium text-text mb-2">{t.maturity.label}</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            {t.maturity.options.map((option) => (
              <button
                type="button"
                x-on:click={`formData.ai_maturity = ${option.value}`}
                x-bind:class={`formData.ai_maturity === ${option.value} ? 'border-primary bg-primary/5 ring-2 ring-primary/20' : 'border-gray-200 hover:border-primary/50'`}
                class="flex flex-col items-start p-3 border-2 rounded-xl transition-all text-left cursor-pointer"
              >
                <span class="font-medium text-text text-sm">{option.label}</span>
                <span class="text-xs text-muted">{option.desc}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Tools Frequent -->
        <div>
          <label class="block text-sm font-medium text-text mb-1.5">{t.toolsFrequent.label}</label>
          <input
            type="text"
            x-model="formData.tools"
            placeholder={t.toolsFrequent.placeholder}
            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
          />
        </div>

        <!-- Tools Occasional -->
        <div>
          <label class="block text-sm font-medium text-text mb-1.5">{t.toolsOccasional.label}</label>
          <input
            type="text"
            x-model="formData.tools_occasional"
            placeholder={t.toolsOccasional.placeholder}
            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle text-sm"
          />
        </div>

        <!-- AI Priority Cards (optional multi-select) -->
        <div>
          <label class="block text-sm font-medium text-text mb-1.5">
            {t.aiPriority.label} <span class="text-muted font-normal">{t.aiPriority.optional}</span>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            {t.aiPriority.cards.map((card) => (
              <button
                type="button"
                x-on:click={`formData.ai_priority.includes('${card.value}') ? formData.ai_priority = formData.ai_priority.filter(v => v !== '${card.value}') : formData.ai_priority.push('${card.value}')`}
                x-bind:class={`formData.ai_priority.includes('${card.value}') ? 'border-primary bg-primary/5 ring-2 ring-primary/20' : 'border-gray-200 hover:border-primary/50'`}
                class="flex flex-col items-center p-4 border-2 rounded-xl transition-all cursor-pointer text-center"
              >
                <span class="text-2xl mb-2">{card.icon}</span>
                <span class="font-semibold text-text text-sm">{card.title}</span>
                <span class="text-xs text-muted mt-1">{card.desc}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Repetitive Process -->
        <div>
          <label class="block text-sm font-medium text-text mb-1.5">{t.repetitiveProcess.label}</label>
          <textarea
            x-model="formData.repetitive_process"
            rows="2"
            placeholder={t.repetitiveProcess.placeholder}
            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle resize-none text-sm"
          ></textarea>
        </div>

        <!-- Objectives -->
        <div>
          <label class="block text-sm font-medium text-text mb-1.5">{t.objectives.label}</label>
          <textarea
            x-model="formData.ai_objectives"
            rows="2"
            placeholder={t.objectives.placeholder}
            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text placeholder:text-subtle resize-none text-sm"
          ></textarea>
        </div>

        <!-- GDPR Consent -->
        <div class="pt-1">
          <label class="flex items-start gap-2.5 cursor-pointer group">
            <input
              type="checkbox"
              x-model="formData.gdpr_consent"
              class="mt-0.5 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
            />
            <span class="text-xs text-gray-600 group-hover:text-gray-800">
              {t.gdpr.label}
              <a href={lang === 'fr' ? '/confidentialite' : '/en/privacy'} target="_blank" class="text-primary hover:underline ml-1">
                {t.gdpr.link}
              </a>
            </span>
          </label>
        </div>
      </div>

      <!-- Error Message -->
      <div
        x-show="error"
        x-cloak
        x-transition
        class="mt-4 p-3 bg-red-50 border-2 border-red-200 rounded-lg"
      >
        <p class="text-red-600 text-center text-sm font-medium" x-text="errorMessage"></p>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-center mt-6">
        <button
          type="button"
          x-on:click="submitForm()"
          x-bind:disabled="loading || !formData.gdpr_consent || !formData.contact_name || !formData.email || !formData.company_name || !formData.sector || !formData.company_size || (!formData.website && !formData.activity_description)"
          class="w-full sm:w-auto px-8 py-3 bg-gradient-to-r from-primary to-secondary text-white font-bold rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-sm"
        >
          <span x-show="!loading">{t.submit}</span>
          <span x-show="loading" x-cloak class="flex items-center gap-2">
            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>{lang === 'fr' ? 'Envoi...' : 'Sending...'}</span>
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Success State -->
  <div
    x-show="success"
    x-cloak
    x-transition:enter="transition ease-out duration-500"
    x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100"
    class="bg-white rounded-2xl shadow-xl p-6 md:p-8 text-center"
  >
    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
      <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <h2 class="text-xl md:text-2xl font-heading font-bold text-text mb-3">{t.success.title}</h2>
    <p class="text-muted mb-3 max-w-md mx-auto text-sm">{t.success.message}</p>
    <p class="text-xs text-muted">{t.success.checkSpam}</p>
  </div>
</div>

<style>
  [x-cloak] {
    display: none !important;
  }
</style>
