---
/**
 * Savings Calculator Component
 * Simple slider-based calculator showing potential annual savings from automation
 * Uses Alpine.js for reactivity + IP-based country detection (same as pricing)
 */
interface Props {
  lang: 'fr' | 'en';
}

const { lang } = Astro.props;

import { useTranslations } from '../i18n/utils';
const t = useTranslations(lang);

// Country to hourly rate mapping (loaded labor cost in EUR)
const countryRates: Record<string, { code: string; rate: number }> = {
  FR: { code: 'fr', rate: 55 },
  BE: { code: 'be', rate: 52 },
  CH: { code: 'ch', rate: 75 },
  DE: { code: 'de', rate: 60 },
  GB: { code: 'uk', rate: 45 },
  US: { code: 'us', rate: 50 },
  AE: { code: 'ae', rate: 40 },
  // Fallback countries to nearest match
  AT: { code: 'de', rate: 60 },  // Austria → Germany rates
  NL: { code: 'be', rate: 52 },  // Netherlands → Belgium rates
  IT: { code: 'fr', rate: 55 },  // Italy → France rates
  ES: { code: 'fr', rate: 55 },  // Spain → France rates
  CA: { code: 'us', rate: 50 },  // Canada → US rates
  AU: { code: 'us', rate: 50 },  // Australia → US rates
};
---

<section class="py-12 bg-surface/30">
  <div class="max-w-2xl mx-auto px-4 text-center"
       x-data="{
         hours: 5,
         rate: 55,
         country: 'fr',
         rates: { fr: 55, be: 52, ch: 75, de: 60, uk: 45, us: 50, ae: 40 },
         detecting: true,
         get savings() { return this.hours * this.rate * 52 },
         async detectCountry() {
           try {
             // Check localStorage first (same key pattern as pricing)
             const saved = localStorage.getItem('vecia_calculator_country');
             if (saved && this.rates[saved]) {
               this.country = saved;
               this.rate = this.rates[saved];
               this.detecting = false;
               return;
             }
             // Use ipapi.co (same as pricing detection)
             const response = await fetch('https://ipapi.co/json/');
             if (response.ok) {
               const data = await response.json();
               const countryCode = data.country_code;
               const mapping = {
                 FR: 'fr', BE: 'be', CH: 'ch', DE: 'de', GB: 'uk', US: 'us', AE: 'ae',
                 AT: 'de', NL: 'be', IT: 'fr', ES: 'fr', CA: 'us', AU: 'us'
               };
               const detected = mapping[countryCode] || 'fr';
               this.country = detected;
               this.rate = this.rates[detected];
               localStorage.setItem('vecia_calculator_country', detected);
             }
           } catch (e) {
             console.log('Country detection failed, using default');
           }
           this.detecting = false;
         }
       }"
       x-init="detectCountry()">

    <h3 class="text-xl md:text-2xl font-bold text-text mb-2">
      {t('calculator.title')}
    </h3>
    <p class="text-muted text-sm mb-8">
      {t('calculator.subtitle')}
    </p>

    <!-- Country selector -->
    <div class="mb-6">
      <select
        x-model="country"
        x-on:change="rate = rates[country]"
        class="px-4 py-2 rounded-lg border border-border/50 bg-background text-text text-sm cursor-pointer hover:border-primary/50 transition-colors"
      >
        <option value="fr">France (€55/h)</option>
        <option value="be">Belgique (€52/h)</option>
        <option value="ch">Suisse (€75/h)</option>
        <option value="de">Deutschland (€60/h)</option>
        <option value="uk">UK (€45/h)</option>
        <option value="us">USA (€50/h)</option>
        <option value="ae">UAE (€40/h)</option>
      </select>
    </div>

    <!-- Hours slider -->
    <div class="mb-8">
      <label class="text-sm text-muted block mb-3">{t('calculator.hoursLabel')}</label>
      <input
        type="range"
        min="1"
        max="40"
        x-model="hours"
        class="savings-slider w-full h-3 rounded-full cursor-pointer"
      />
      <div class="mt-3">
        <span class="text-3xl md:text-4xl font-bold text-primary" x-text="hours + 'h'"></span>
        <span class="text-muted">{t('calculator.perWeek')}</span>
      </div>
    </div>

    <!-- Result -->
    <div class="p-6 rounded-xl bg-primary/10 border border-primary/20">
      <p class="text-sm text-muted mb-2">{t('calculator.resultLabel')}</p>
      <p class="text-4xl md:text-5xl font-bold text-primary">
        <span x-text="'€' + savings.toLocaleString('fr-FR')"></span>
      </p>
      <p class="text-xs text-muted mt-2">{t('calculator.perYear')}</p>
    </div>

    <!-- Real example anchor -->
    <p class="text-sm text-muted mt-6 italic">
      {t('calculator.realExample')}
    </p>
  </div>
</section>

<style>
  /* Custom range slider styling for cross-browser consistency */
  .savings-slider {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
  }

  /* Track - WebKit (Chrome, Safari, Edge) */
  .savings-slider::-webkit-slider-runnable-track {
    height: 8px;
    background: linear-gradient(to right, rgba(var(--color-primary-rgb, 99, 102, 241), 0.3), rgba(var(--color-primary-rgb, 99, 102, 241), 0.15));
    border-radius: 9999px;
    border: 1px solid rgba(var(--color-border-rgb, 148, 163, 184), 0.3);
  }

  /* Track - Firefox */
  .savings-slider::-moz-range-track {
    height: 8px;
    background: linear-gradient(to right, rgba(var(--color-primary-rgb, 99, 102, 241), 0.3), rgba(var(--color-primary-rgb, 99, 102, 241), 0.15));
    border-radius: 9999px;
    border: 1px solid rgba(var(--color-border-rgb, 148, 163, 184), 0.3);
  }

  /* Thumb - WebKit */
  .savings-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    background: rgb(var(--color-primary-rgb, 99, 102, 241));
    border-radius: 50%;
    cursor: pointer;
    margin-top: -8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .savings-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(var(--color-primary-rgb, 99, 102, 241), 0.4);
  }

  /* Thumb - Firefox */
  .savings-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    background: rgb(var(--color-primary-rgb, 99, 102, 241));
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .savings-slider::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(var(--color-primary-rgb, 99, 102, 241), 0.4);
  }

  /* Focus state */
  .savings-slider:focus {
    outline: none;
  }

  .savings-slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb, 99, 102, 241), 0.2);
  }

  .savings-slider:focus::-moz-range-thumb {
    box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb, 99, 102, 241), 0.2);
  }
</style>
