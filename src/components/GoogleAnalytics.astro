---
/**
 * Google Analytics 4 with Consent Mode V2
 *
 * Implements Google Consent Mode V2 (mandatory since March 2024)
 * GDPR-compliant: Only loads after user consent via CookieConsent component
 *
 * Measurement ID: G-3RQR1S5ZK3
 *
 * Features:
 * - IP anonymization
 * - Consent Mode V2 (analytics_storage denied by default)
 * - View Transitions compatibility (astro:page-load events)
 * - Real-time tracking
 */

// Access environment variable directly (Astro 5.x compatible)
const GA_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID || 'G-3RQR1S5ZK3';
---

<!-- Google tag (gtag.js) with Consent Mode V2 -->
<script
  is:inline
  type="text/partytown"
  async
  src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>

<script is:inline define:vars={{ GA_ID }}>
  // Initialize dataLayer
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Set default consent to DENIED (GDPR compliance)
  // This will be updated by CookieConsent.astro when user makes a choice
  gtag('consent', 'default', {
    analytics_storage: 'denied',
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    wait_for_update: 500, // Wait 500ms for consent to be updated
  });

  // Initialize GA4
  gtag('js', new Date());
  gtag('config', GA_ID, {
    // IP anonymization (GDPR best practice)
    anonymize_ip: true,

    // Send page view on load
    send_page_view: true,

    // Cookie settings
    cookie_flags: 'SameSite=Lax;Secure',

    // Respect Do Not Track
    allow_google_signals: false,

    // Enable enhanced measurement
    enhanced_measurement: {
      scrolls: true,
      outbound_clicks: true,
      site_search: true,
      video_engagement: false,
      file_downloads: true,
    },
  });

  // Log initialization
  console.log('[GA4] Initialized with Consent Mode V2');
</script>

<!-- Astro View Transitions Support -->
<script>
  // Re-trigger pageview on View Transitions navigation
  document.addEventListener('astro:page-load', () => {
    if (typeof window.gtag !== 'undefined') {
      window.gtag('event', 'page_view', {
        page_path: window.location.pathname,
        page_title: document.title,
        page_location: window.location.href,
      });

      console.log('[GA4] Page view tracked:', window.location.pathname);
    }
  });

  // Track outbound links
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('a[href^="http"]').forEach((link) => {
      if (!link.href.includes(window.location.hostname)) {
        link.addEventListener('click', () => {
          if (typeof window.gtag !== 'undefined') {
            window.gtag('event', 'click', {
              event_category: 'outbound',
              event_label: link.href,
              transport_type: 'beacon',
            });
          }
        });
      }
    });
  });
</script>

<!-- Debug Mode (remove in production) -->
<script is:inline>
  // Check if GA4 is loaded
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (typeof window.gtag !== 'undefined') {
        console.log('[GA4] Status: Loaded ✅');
        console.log('[GA4] Measurement ID:', GA_ID);
        console.log('[GA4] Consent Mode V2: Active ✅');
      } else {
        console.warn('[GA4] Status: Not loaded ⚠️');
      }
    }, 1000);
  });
</script>
