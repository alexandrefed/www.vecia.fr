# GitHub Actions Workflow for Astro Deployment to Vecia VPS (Docker)
# Migrated from PM2 to Docker for better reliability and automatic restarts

name: Deploy Astro to Vecia VPS (Docker)

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: vecia-website:${{ github.sha }},vecia-website:latest
          build-args: |
            NODE_VERSION=20.18.1
            PUBLIC_SITE_URL=https://vecia.fr
            PUBLIC_CAL_EMBED_URL=https://cal.vecia.fr
            PUBLIC_META_PIXEL_ID=${{ secrets.PUBLIC_META_PIXEL_ID }}
            PUBLIC_LINKEDIN_PARTNER_ID=${{ secrets.PUBLIC_LINKEDIN_PARTNER_ID }}
            PUBLIC_GA_MEASUREMENT_ID=${{ secrets.PUBLIC_GA_MEASUREMENT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image to tar
        run: |
          echo "ðŸ“¦ Saving Docker image..."
          docker save vecia-website:latest | gzip > vecia-website.tar.gz
          ls -lh vecia-website.tar.gz
          echo "âœ… Image saved"

      - name: Setup SSH key (decode base64 and validate)
        id: ssh_key
        run: |
          echo "====== Decoding and Validating SSH Key ======"
          mkdir -p ~/.ssh
          echo -n "${{ secrets.VPS_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "Key fingerprint:"
          ssh-keygen -l -f ~/.ssh/deploy_key || echo "âŒ Key validation failed"

          ssh-keyscan -H -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

          # Output decoded key for appleboy/ssh-action
          echo "decoded_key<<EOF" >> $GITHUB_OUTPUT
          cat ~/.ssh/deploy_key >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… SSH key ready for deployment"

      - name: Transfer Docker image to VPS
        run: |
          echo "ðŸš€ Transferring Docker image to VPS..."
          rsync -avz --progress \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT }}" \
            vecia-website.tar.gz \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_TARGET_DIR }}/ \
          | tail -20
          echo "âœ… Image transfer complete"

      - name: Transfer Docker Compose files to VPS
        run: |
          echo "ðŸ“‹ Transferring docker-compose.yml..."
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT }}" \
            docker-compose.yml \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_TARGET_DIR }}/
          echo "âœ… Compose file transferred"

      - name: Deploy with Docker Compose on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ steps.ssh_key.outputs.decoded_key }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd ${{ secrets.VPS_TARGET_DIR }}

            echo "ðŸ“¥ Loading Docker image..."
            gunzip -c vecia-website.tar.gz | docker load

            echo "ðŸ”§ Creating/updating .env file..."
            # PUBLIC_SUPABASE_URL: External IP for client-side (browser) requests
            # SUPABASE_URL: Internal Docker network for server-side (SSR) requests
            cat > .env << EOF
            PUBLIC_SUPABASE_URL=http://85.25.172.47:8100
            PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_URL=http://supabase-kong:8000
            SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
            PUBLIC_GA_MEASUREMENT_ID=${{ secrets.PUBLIC_GA_MEASUREMENT_ID }}
            PUBLIC_META_PIXEL_ID=${{ secrets.PUBLIC_META_PIXEL_ID }}
            PUBLIC_LINKEDIN_PARTNER_ID=${{ secrets.PUBLIC_LINKEDIN_PARTNER_ID }}
            EOF

            echo "ðŸ”„ Deploying with Docker Compose..."
            docker compose down || true
            docker compose up -d

            echo "ðŸ§¹ Clearing nginx cache..."
            # Clear nginx proxy cache to prevent serving stale HTML with old asset hashes
            sudo rm -rf /var/cache/nginx/* 2>/dev/null || true
            sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Nginx reload skipped (not critical)"

            echo "â³ Waiting for container to be healthy..."
            timeout 60 bash -c 'until docker inspect vecia-website --format="{{.State.Health.Status}}" 2>/dev/null | grep -q "healthy"; do sleep 2; echo -n "."; done' || {
              echo ""
              echo "âŒ Health check timeout!"
              echo "ðŸ“‹ Container status:"
              docker compose ps
              echo ""
              echo "ðŸ”´ Container logs:"
              docker compose logs --tail=100
              exit 1
            }

            echo ""
            echo "âœ… Container is healthy!"

            # Clean up old images (keep last 2 versions)
            echo "ðŸ—‘ï¸  Cleaning up old Docker images..."
            docker image prune -f || true

            echo ""
            echo "=========================================="
            echo "âœ… Deployment successful!"
            echo "=========================================="
            echo "ðŸ“ Deployed to: ${{ secrets.VPS_TARGET_DIR }}"
            echo "ðŸ³ Container: vecia-website"
            echo "ðŸŒ Website: https://vecia.com"
            echo "ðŸ“… Deployed at: $(date)"
            echo ""
            echo "ðŸ“Š Container status:"
            docker compose ps
            echo ""
            echo "ðŸ’¾ Resource usage:"
            docker stats vecia-website --no-stream

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ steps.ssh_key.outputs.decoded_key }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ðŸ” Testing health endpoint..."
            HEALTH_RESPONSE=$(curl -f -s http://127.0.0.1:4322/api/health.json)

            if [ $? -eq 0 ]; then
              echo "âœ… Health check passed"
              echo "Response: $HEALTH_RESPONSE"
            else
              echo "âŒ Health check failed"
              docker compose logs --tail=50
              exit 1
            fi

            echo ""
            echo "ðŸ” Testing Nginx..."
            if curl -f -s -I https://vecia.com | grep -q "200 OK"; then
              echo "âœ… Nginx serving site successfully"
            else
              echo "âš ï¸  Nginx health check inconclusive"
            fi

            echo ""
            echo "âœ… All checks passed - Deployment verified!"

      - name: Ensure Certbot Auto-Renewal
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ steps.ssh_key.outputs.decoded_key }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ðŸ” Checking Certbot auto-renewal configuration..."

            # Check if certbot renewal cron exists
            if ! sudo crontab -l 2>/dev/null | grep -q "certbot renew"; then
              echo "ðŸ“ Setting up certbot auto-renewal..."
              (sudo crontab -l 2>/dev/null; echo "0 3 * * * /usr/bin/certbot renew --quiet --deploy-hook 'nginx -s reload'") | sudo crontab -
              echo "âœ… Certbot auto-renewal configured (daily at 3am)"
            else
              echo "âœ… Certbot auto-renewal already configured"
            fi

            # Show current cron job
            echo ""
            echo "ðŸ“‹ Current certbot cron:"
            sudo crontab -l 2>/dev/null | grep certbot || echo "  (none found)"
