# SSL Certificate Monitor for Vecia Website
# Checks certificate expiry daily and creates GitHub issue if expiring soon
# Prevents unexpected SSL expiration and downtime

name: SSL Certificate Monitor

on:
  schedule:
    # Check every day at 8am Paris time
    - cron: '0 7 * * *'  # UTC (Paris is UTC+1)
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-ssl:
    name: Check SSL Certificate
    runs-on: ubuntu-latest

    steps:
      - name: Check SSL Certificate Expiry
        id: ssl-check
        run: |
          DOMAIN="www.vecia.fr"
          echo "üîê Checking SSL certificate for $DOMAIN..."

          # Get certificate expiry date
          EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)

          if [ -z "$EXPIRY" ]; then
            echo "‚ùå Failed to retrieve certificate"
            exit 1
          fi

          # Calculate days until expiry
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "expiry_date=$EXPIRY" >> $GITHUB_OUTPUT

          echo ""
          echo "üìÖ Certificate expires: $EXPIRY"
          echo "‚è≥ Days remaining: $DAYS_LEFT"
          echo ""

          if [ $DAYS_LEFT -lt 14 ]; then
            echo "‚ö†Ô∏è WARNING: SSL certificate expires in $DAYS_LEFT days!"
            echo "urgent=true" >> $GITHUB_OUTPUT
            exit 1
          elif [ $DAYS_LEFT -lt 30 ]; then
            echo "‚ö° NOTICE: SSL certificate expires in $DAYS_LEFT days"
            echo "urgent=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ SSL certificate valid for $DAYS_LEFT days"
            echo "urgent=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout for issue creation
        if: failure()
        uses: actions/checkout@v4

      - name: Create Issue if Expiring Soon
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const daysLeft = '${{ steps.ssl-check.outputs.days_left }}';
            const expiryDate = '${{ steps.ssl-check.outputs.expiry_date }}';

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,ssl'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('SSL Certificate')
            );

            if (existingIssue) {
              console.log('Similar issue already exists: #' + existingIssue.number);
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `‚è∞ **Update**: Certificate now expires in **${daysLeft} days** (${expiryDate})`
              });
              return;
            }

            // Create new issue with properly escaped body
            const issueBody = [
              '## SSL Certificate Warning',
              '',
              'The SSL certificate for **www.vecia.fr** is expiring soon.',
              '',
              '| Metric | Value |',
              '|--------|-------|',
              '| **Days Remaining** | ' + daysLeft + ' days |',
              '| **Expiry Date** | ' + expiryDate + ' |',
              '| **Domain** | www.vecia.fr |',
              '',
              '## Action Required',
              '',
              '1. SSH to VPS: `ssh user@85.25.172.47`',
              '2. Renew certificate: `sudo certbot renew`',
              '3. Reload nginx: `sudo nginx -s reload`',
              '',
              'Or wait for auto-renewal (runs daily at 3am via cron).',
              '',
              '---',
              'ü§ñ This issue was automatically created by the SSL Monitor workflow.'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è SSL Certificate Expiring Soon - www.vecia.fr',
              body: issueBody,
              labels: ['security', 'ssl', 'urgent']
            });

            console.log('Created new SSL warning issue');
