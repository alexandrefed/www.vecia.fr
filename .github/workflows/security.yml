# Security Checks Workflow for Vecia Website
# Runs security audits on every push/PR + weekly scheduled scan
# Prevents deploying code with known vulnerabilities

name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly scan every Sunday at 2am Paris time
    - cron: '0 1 * * 0'  # UTC (Paris is UTC+1)
  workflow_dispatch:  # Allow manual trigger

jobs:
  security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # NPM Audit - fail on high/critical vulnerabilities
      - name: NPM Security Audit
        run: |
          echo "ğŸ” Running npm audit..."
          npm audit --audit-level=high
          echo "âœ… No high/critical vulnerabilities found"

      # Lockfile validation - detect supply chain attacks
      - name: Validate Lockfile
        run: |
          echo "ğŸ”’ Validating package-lock.json integrity..."
          npm run security:lockfile
          echo "âœ… Lockfile validation passed"

      # TypeScript type checking (non-blocking - reports but doesn't fail)
      - name: Astro Type Check
        continue-on-error: true
        run: |
          echo "ğŸ“ Running TypeScript type check..."
          npx astro check || echo "âš ï¸ TypeScript issues found (non-blocking)"
          echo "â„¹ï¸ Type errors are reported but don't block security checks"

      # Build verification
      - name: Build Test
        run: |
          echo "ğŸ—ï¸ Testing production build..."
          npm run build
          echo "âœ… Build successful"

  # Container scanning (on main branch only)
  container-scan:
    name: Docker Container Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          echo "ğŸ³ Building Docker image for security scan..."
          docker build -t vecia-website:scan .
          echo "âœ… Image built"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'vecia-website:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities, just report

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Display scan summary
        if: always()
        run: |
          echo "ğŸ“Š Container scan complete"
          echo "Results uploaded to GitHub Security tab"
